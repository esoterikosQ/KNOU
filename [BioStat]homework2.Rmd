---
title: "Untitled"
author: "SeungGyu Bak"
date: "2022-11-08"
output: word_document
---

## 1. 다음은 어떤 감염성 질병에 대한 환자 6명의 검사 결과와 실제 감염 여부이다. 

|환자번호  |검사 결과 점수  |실제 감염 여부|
|----------|----------------|--------------|
|1         |5               |음성          |
|2         |8               |양성          |
|3         |9               |음성          |
|4         |13              |양성          |
|5         |25              |양성          |
|6         |30              |양성          |


### A. 점수가 10점 이상이면 양성으로 판정한다고 할 경우, 이 판정법의 민감도(sensitivity), 특이도(specificity), 양성예측도(positive predictive value), 음성예측도(negative predictive value)는 각각 얼마인가?(3점)
  
주어진 데이터를 바탕으로 10점을 양성의 기준으로 판단하는 경우, 검사결과와 실제 감염 여부를 분할표로 나타내면 다음과 같다.

|구분      |실제 양성 |실제 음성 |합계 |
|----------|----------|----------|-----|
|검사 양성 |3         |0         |3    |
|검사 음성 |1         |2         |3    |
  
민감도란 실제 양성인 사례 수 중 양성 판정을 받은 비율을 나타내는 지표로, 주어진 사례에서 다음과 같이 계산할 수 있다.

$$
sensitivity = P(\hat y = 1 | y = 1) = \frac{P(\hat y = 1 \cap y = 1)}{P(y = 1)} = \frac{\frac{3}{6}}{\frac{4}{6}} = 0.75
$$
  
특이도란 실제 음성인 사례 수 중 음성 판정을 받은 비율을 나타내는 지표로, 주어진 사례에서 다음과 같이 계산할 수 있다.

$$
specificity = P(\hat y = 0 | y = 0) = \frac{P(\hat y = 0 \cap y = 0)}{P(y = 0)} = \frac{\frac{2}{6}}{\frac{2}{6}} = 1
$$
  
양성예측도란 양성 판정을 받은 사례 수 중 실제 양성인 비율을 나타내는 지표로, 다음과 같이 계산할 수 있다.

$$
PPV = P(y=1|\hat y =1) = \frac{P(y = 1 \cap \hat y = 1)}{P(\hat y = 1)} = \frac{\frac{3}{6}}{\frac{3}{6}} = 1
$$
  
음성예측도란 음성 판정을 받은 사례 수 중 실제 음성인 비율을 나타내는 지표로, 다음과 같이 계산할 수 있다.

$$
NPV = P(y=0|\hat y =0) = \frac{P(y = 0 \cap \hat y = 0)}{P(\hat y = 0)} = \frac{\frac{2}{6}}{\frac{3}{6}} = 0.67
$$
  
이상의 결과를 정리하면 다음과 같다.


|민감도 | 특이도 | 양성예측도 |음성예측도 |
|-------|--------|------------|-----------|
|0.75   |1       |1           |0.67       |


### B. A문항에서는 판정을 위한 컷오프를 10점으로 사용하였다. 아래의 표에 있는 각각의 컷오프에 대한 민감도와 특이도를 모두 계산하여 빈칸을 채우시오. (3점)
  
컷오프를 다르게 하는 경우, 진양성과 진음성의 숫자가 달라진다. 컷오프의 변화에 따른 진양성, 진음성, 양성환자 수, 음성환자 수의 변화와 함께 민감도, 특이도를 나타내면 다음과 같다.
  
|컷오프 |TP |NP |TF |NF |민감도 | 특이도 |
|-------|---|---|---|---|-------|--------|
|4      |4  |2  |0  |0  |1      |0       |
|6      |4  |1  |1  |0  |1      |0.5     |
|8.5    |3  |1  |1  |1  |0.75   |0.5     |
|10     |3  |0  |2  |1  |0.75   |1       |
|14     |2  |0  |2  |2  |0.5    |1       |
|26     |1  |0  |2  |3  |0.25   |1       |
|31     |0  |0  |2  |4  |0      |1       |

  
### C. B문항에서 계산한 결과를 이용하여, 각 컷오프에 대하여 가로축에 (1-특이도), 세로축에 민감도를 나타내는 점을 찍고 연결하여 ROC curve를 그리시오. (손으로 그려서 사진을 제출해도 되고, 엑셀이나 R 등을 사용해서 그려도 됨) (3점)
  

B의 결과를 바탕으로 ROC curve를 그리면 다음과 같다.

``` {r}
# load packages
library(pROC)
library(ggplot2)

# insert the data
actual <- c(0, 1, 0, 1, 1, 1)
result <- c(5, 8, 9, 13, 25, 30)

# calculate auc
auc_res <- round(auc(actual, result), 4)

# draw roc curve
roc_obj <- roc(actual, result)
ggroc(roc_obj, color = 'red') +
  ggtitle(paste0('ROC curve', '(AUC = ', auc_res, ')')) +
  theme_minimal()
```
  
(참고사이트) https://www.statology.org/roc-curve-ggplot2/

  
  
## 2. 데이터 파일 dp.RData에는 환자 100명의 우울증 여부, 성별, 우울증 점수가 들어있다. 이 데이터를 이용하여 다음의 문항에 답하시오. 풀이에 사용한 R 코드와 출력결과를 답안에 포함하시오.

```{r 2.a}
load(file="dp.RData")
```
  
  
### B. 변수 depression은 우울증 여부를 나타낸다. (1이면 우울증이 있음, 0이면 우울증 없음) 변수 score는 우울증 테스트 점수이며 높을수록 우울증 가능성이 높음을 나타낸다. 우울증에 대한 우울증 테스트 점수의 ROC curve를 R을 이용하여 그리고 AUC(Area under the ROC curve)를 계산하시오. (5점)

```{r 2.b}
# calculate answers
attach(dp)
roc_obj2 <- roc(depression, score)
auc_res2 <- round(auc(depression, score), 4)

# draw roc curve
ggroc(roc_obj2, color = 'darkblue') +
  ggtitle(paste0('ROC curve', '(AUC = ', auc_res2, ')')) +
  theme_minimal()

```
  
### C. 우울증 여부(depression)를 결과변수(종속변수)로, 성별(gender)과 우울증 테스트 점수(score)를 설명변수(독립변수)로 하는 로지스틱 회귀분석을 수행하시오. 성별의 OR(오즈비)는 얼마인가? 이 로지스틱 회귀분석을 통해 추정한 성별의 OR 추정치에 따르면, 남성과 여성 중 어느 쪽이 우울증 가능성이 더 높은가? (6점)
  
```{r 2.c}
fit <- glm(depression ~ gender + score, family = binomial)
summary(fit)
```
  
주어진 데이터를 바탕으로 설정한 로지스틱 회귀모형과 데이터를 적합한 결과는 다음과 같다. 

$$
logit[P(Y=1)] = \alpha + \beta_1x_{gender} + \beta_2x_{score} = -5.9484 - 0.4567x_{gender} + 0.2123x_{score}
$$
  
모형에 대해 평가하면, 우도비 검정값은 100.08 - 88.392 = 11.688, df = 99 - 97 = 2로 $\chi^2$ 분포에서 이보다 극단적인 값을 가질 확률(p-value)은 0.0029로, 유의수준 0.05에서 모든 모수가 0이라는 귀무가설을 기각할 수 있어 모형은 통계적으로 유의미한 것으로 결론내릴 수 있다. 잔차 이탈도는 88.392, df = 97로 해당 통계량을 기준으로 p-value는 0.722이다. 따라서, 유의수준 0.05에서 회귀모형이 관측치와 일치한다는 귀무가설을 기각할 수 없어 모형이 적합하다고 결론을 내릴 수 있다. 각 모수의 95% 신뢰구간(Wald)을 구하면 gender 변수는 $-0.4567 \pm 1.96 \times 0.5583 = (-1.551, 0.6376)$, score 변수는 $0.2123 \pm 1.96 * 0.0807 = (0.0631, 0.3795)$로, 유의수준 0.05에서 gender 변수의 회귀계수가 0이라는 귀무가설을 기각할 수 없는 것을 확인할 수 있다.
  
회귀모형에 따라 오즈비를 계산하면, 성별이 남성인 경우 우울증이 있을 오즈는 여성인 경우의 $e^{-0.4567} = 0.6334$배이다. 따라서 다른 조건이 동일할 때에 남성에게 우울증이 있을 오즈는 여성에게 우울증이 있을 오즈보다 약 37% 낮기 때문에 상대적으로 남성이 여성보다 우울증이 있을 가능성이 낮다고 할 수 있다.

