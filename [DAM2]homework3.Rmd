---
title: "Untitled"
author: "SeungGyu Bak"
date: "2022-09-23"
output: word_document
---

```{r setup, include=FALSE}
library(glm2)
library(binom)
library(car)
```

## 3.5. 만일 참게가 적어도 한 마리의 부수체(sat)를 가지면 y=1이라 하고 그렇지 않으면 y=0이라 하자.

### a. 무게(weight, 단위:kg)를 예측변수로 하는 P(Y=1)의 선형확률모형을 적합하여라. 만약 당신의 소프트웨어가 이항분포에 대해서 항등연결함수를 사용할 수 없거나 수렴하지 않으면 Y를 정규분포를 따르는 것처럼 간주하여 보통의 최소제곱법을 이용하여 모수를 추정하고 추정값들을 해석하여라. 가장 큰 무게값 5.20kg에 대하여 P(Y=1)을 예측하고 결론을 내려라.

```{r 5-a}
dt <- read.table('Crabs.txt', header = TRUE)
fit <- glm(y~weight, family=quasi(link = "identity", variance = 'mu(1-mu)'), start=c(0.1,0.1), data=dt, control = glm.control(trace=TRUE))
summary(fit)
```
  
  부수체 존재 여부를 반응변수로, 투구게의 중량을 설명변수로 하는 선형회귀식을 적합한 결과는 위와 같다. 반응변수가 이항변수인 경우 선형회귀모형은 선형확률모형이라고 부르며, R에서 glm 함수를 이용하는 경우, 연결함수의 분산을 이항분포의 분산과 동일하게 설정하고(variance = 'mu(1-mu)'), 0이 아닌 모수의 적절한 시작점을 지정해주면(start = c(0.1, 0.1)) 수차례의 에러메시지와 함께 모형적합이 이루어진다. 사례의 모형과 주어진 데이터를 바탕으로 계산한 계수는 다음과 같다. 
  
$$
P(Y=1) = \alpha + \beta x = 0.1476 + 0.1639x
$$
  
  선형확률모형의 회귀계수 추정치 $\hat{\beta}$=0.1639로 추정되었다. 즉, 개체의 중량 1kg이 증가할 때마다 부수체를 가질 확률은 0.1639만큼 증가한다. 주어진 데이터에서 가장 큰 개체의 중량인 5.2kg을 주어진 모형에 대입하면 부수체를 가질 확률은 다음과 같다.
  
$$
\hat P(Y=1) = 0.1476 + 0.1639 \times 5.2 = 0.9999
$$
  
  이항분포에 대해 항등연결함수를 사용하지 않고 단순히 최소제곱법을 이용하여 모수를 추정한 결과와 모형은 다음과 같다.
  
```{r 5-a-2}
fit2 <- lm(y~weight, data=dt)
summary(fit2)
```
  
$$
\hat P(Y=1) = \alpha + \beta x = -0.1449 + 0.3227x
$$
  
 위 모형을 바탕으로 중량이 5.2kg인 개체가 부수체를 가질 확률을 예측하면 $P(Y=1) = -0.1449 + 0.3227 \times 5.2 = 1.5331$이라는 결과가 나온다.  
 이와 같은 결과는 이항변수에 대해 선형확률모형을 적합하는 경우 관측값에 따라서 반응변수의 예측값이 [0, 1]의 범위를 벗어날 수 있다는 것을 보여준다.
 
 
b. Y를 이항변수로 간주하고 로지스틱회귀모형을 적합하여라. 무게값 5.20kg에 대하여 P(Y=1)의 예측값 $\hat{P}$(Y=1) = 0.9968이 됨을 보여라.

```{r 5-b}
fit3 <- glm(y~weight, family=binomial, data=dt)
summary(fit3)
```
  
이항변수에 대한 로지스틱 회귀 모형식은 다음과 같다. ($\pi = P(Y=1)$)

$$
logit[\pi] = log[\frac{\pi}{1-\pi}] =log[\frac{P(Y=1)}{1-P(Y=1)}] = \alpha + \beta x = -3.6947 + 1.8151x
$$
  
  주어진 모형을 바탕으로 중량이 5.2kg인 개체의 P(Y=1)값을 계산하면 다음과 같다.
  
$$
\hat P(Y=1) = \frac{e^{-3.6947+1.8151 \times 5.2}}{1 + e^{-3.6947 + 1.8151 \times 5.2}} = \frac{312.2549495}{1+312.2549495} = 0.9968
$$
  
  모형을 이용한 적합치에서도 동일한 결론을 얻을 수 있다.

```{r 5-b-2}
fitted(fit3)[which.max(dt$weight)]
```


## 3.6. 2016년도 일반사회조사에서 18세에서 27세까지를 대상으로 정치성향(1=매우 보수적, 2=보수적, 3=약간 보수적, 4=중간, 5=약간 진보적, 6=진보적, 7=매우 진보적)과 정당(민주당, 공화당)에 대하여 교차분할표를 구한 것이다.
           | 1 | 2  | 3  | 4  | 5 | 6 | 7 |
-----------|---|----|----|----|---|---|---|
Democrat   | 5 | 18 | 19 | 25 | 7 | 7 | 2 |
Republican | 1 | 3 | 1 | 11 | 10 | 11 | 1 |

### 지지정당이 민주당일 확률에 영향을 미치는 정치성향의 효과를 보기 위해 R을 이용하여 모형을 적합한 결과가 다음과 같다.

```{r}
y <- c(5, 18, 19, 25, 7, 7, 2)
n <- c(6, 21, 20, 36, 17, 18, 3)
x <- c(1, 2, 3, 4, 5, 6, 7)
fit <- glm(y/n ~ x, family=binomial(link=logit), weights = n)
summary(fit)
```

```{r}
confint(fit)
```

### a. 예측식을 제시하고 정치성향 효과의 방향에 대해서 해석하라.
  
  주어진 데이터를 바탕으로 적합한 로지스틱 회귀모형 예측식은 다음과 같다.
  
$$
logit[\pi] = log[\frac{P(Y=1)}{1-P(Y=1)}] = \alpha + \beta x = 3.187 - 0.59x
$$
  
  위 모형과 데이터 적합결과에 따르면 정치성향이 1씩 증가할 때마다 민주당을 지지할 확률(P(Y=1))의 오즈는 $e^{0.59} = 0.5543$배씩 작아진다. 즉, 정치성향이 매우 보수적인(x=1) 조사대상자가 민주당을 지지할 확률은 $\frac{e^2.597}{1+e^2.597}=0.93$인 반면, 정치성향이 매주 진보적(x=7)인 대상자가 민주당을 지지할 확률은 $\frac{e^{-0.943}}{1+e^{-0.943}} = 0.28$로 예측할 수 있다.

### b. 정치성향 효과에 대한 95% 왈드 신뢰구간을 구하고 위에 주어진 프로파일 가능도 신뢰구간과 비교하라.
  
  왈드 신뢰구간을 구하기 위한 산식은 다음과 같다.
  
$$
\hat \beta \pm z_{\alpha/2}\times SE
$$
  
회귀모형 적합결과 $\hat \beta=-0.5901$로, 표준오차(SE)는 0.1564로 계산되었다. 해당 수치를 대입하면 회귀계수 추정치에 대한 95% 왈드 신뢰구간은 (-0.8965, -0.2835)로 나타난다. 이는 confint() 명령어를 사용하여 계산한 95% 프로파일 가능도 신뢰구간인 (-0.9159, -0.2983)보다 범위가 좁다. 
  
  
### c. 정치성향 효과에 대한 왈드 검정을 수행하라. 검정통계량과 P-값을 제시하고 결과를 해석하라.
  
  정치성향 효과에 대한 왈드 통계량은 $z = \frac{\hat \beta}{SE} = \frac{-0.5901}{0.1564} = -3.772$로 계산되는데, $z^2 = 14.22798$로, df=1인 $\chi^2$분포 하에서 해당 통계량보다 더 극단적인 값을 가질 확률 p-값은 다음과 같이 계산된다.
  
```{r 6-c}
1-pchisq(14.22798, df=1)
```
  
  따라서, 귀무가설이 참인 경우 모집단에서 랜덤 추출한 표본에서 추정한 회귀계수가 문제에서 주어진 관측치의 회귀계수보다 극단적일 확률은 <0.001이고, 0.05 유의수준에서 귀무가설을 기각할 수 있다. 따라서, 정치성향은 지지정당에 영향을 미친다고 결론내릴 수 있다.
  
  
### d. 가능도비 검정을 수행하고 검정통계량과 P-값을 제시하고 결과를 해석하라.
  
```{r 6-d}
Anova(fit)
```
  
  car 패키지의 Anova() 명령어를 사용하여 가능도비 검정을 수행한 결과는 위와 같다. 귀무가설 하의 최대우도 추정치와 제약조건 없는 최대우도 추정치의 비율값은 17.009로 계산되고, df=1인 $\chi^2$분포 하에서 이보다 더 극단적인 가능도비를 가질 확률은 <0.01로 계산된다. 따라서 0.05 유의수준에서 귀무가설을 기각할 수 있다.
  따라서, 정치성향은 지지정당에 영향을 미친다고 결론내릴 수 있다.
  
  
### e. R출력 결과에 있는 Fisher 스코어 알고리즘의 반복수에 대해서 설명하라.
  
  피셔 스코어 알고리즘이란, 뉴턴의 경사하강법과 유사한 방식으로 최대우도 추정치를 구하기 위해 피셔가 1935년 제안한 방법이다. 경사하강법과 달리 관측치가 주어졌을 때의 우도함수값을 모수로 편미분한 값을 제곱한 값을 바탕으로 최대우도 추정치에 접근하는데, 일반선형회귀 방법에서는 반응변수의 관측치와 추정치 차이가 적은 관측치에 대해 더 높은 가중치를 부여하는 방식으로 최대우도 추정이 이루어진다. 최대우도 추정은 전체 관측치에 대해 편차를 계산하고 이를 바탕으로 최대우도를 계산하는 순환(cycle)이 반복되는데, 매 순환마다 최대우도 추정값이 갱신된다. 이러한 최대우도 추정값 갱신은 더 이상 추정값에 증감이 없을 때까지 이루어지는데, 추정값이 1회 갱신되는 것을 반복(iteration)이라 한다.
  주어진 회귀모형 적합 과정에서는 피셔 스코어 알고리즘의 반복이 4번 이루어진 후 최대우도 추정치를 산출한 것을 알 수 있다. glm.control(trace=TRUE) 인자 통해 최대우도 추정치를 구하는 과정에서 각 반복마다 편차가 어떻게 변하는지를 확인할 수 있다.

```{r 5-e}
fit <- glm(y/n ~ x, family=binomial(link=logit), weights = n, control = glm.control(trace=TRUE))
```



3.11 컴퓨터 칩의 기판을 제조하는 데 사용되는 두 공정 과정의 결함율을 분석하기 위해 실험을 하였다. 10개의 기판에 대해 처리A를 적용했을 때에 기판에서 관측된 결함 수는 각각 8, 7, 6, 6, 3, 4, 7, 2, 3, 4이었다. 10개의 기판에 대하여 처리 B를 적용했을 때에는 결함 수가 9, 9, 8, 14, 8, 13, 11, 5, 7, 6이었다. 결함 수를 각각 평균 $\mu_{A}$와 $\mu_{B}$를 갖는 서로 독립인 포아송 변량이라고 간주하자. 

모형 $log\mu = \alpha + \beta x$에서 처리 A는 x=0, 처리 B는 x=1이다. 여기에서 $\beta = log\mu_{B} - log\mu_{A} = log(\frac{\mu_{B}}{\mu_{A}})$이고 $e^{\beta} = \frac{\mu_B}{\mu_A}$이다.

이 모형을 적합한 후 예측식을 제시하고 $\hat{\beta}$값을 해석하여라.

```{r 11}
a <- data.frame('process' = rep('0', 10), 'defects' = c(8,7,6,6,3,4,7,2,3,4))
b <- data.frame('process' = rep('1', 10), 'defects' = c(9,9,8,14,8,13,11,5,7,6))
dt <- rbind(a, b)
fit <- glm(defects ~ process, family = poisson, data = dt)
summary(fit)
```
  
  주어진 데이터를 바탕으로 적합한 포아송 로그선형모형은 다음과 같다.
  
$$
log(\mu) = \alpha + \beta x = 1.6094 + 0.5878x
$$
  
  적합 결과 회귀계수 추정치 $\hat \beta$는 0.5878로 추정되었고, 해당 계수에 대한 왈드 검정 결과 통계량은 $z^2 = 3.332^2 = 11.1$으로 df=1인 $\chi^2$분포 하에서 해당 통계량보다 극단적인 값을 가질 확률 p-값은 <0.001로 나타난다. 따라서 유의수준 0.05 수준에서 귀무가설 $H_0 : \beta = 0$을 기각한다. 따라서 기판 처리 공정과정은 결함율에 영향을 미친다는 결론을 내릴 수 있다.
  $\hat \beta = 0.5878$로 나타났으므로, 처리 공정과정 B를 거친 컴퓨터칩은 A를 거친 칩에 비해 $e^0.5878 = 1.8$배 많은 결함 수를 가질 것으로 예상할 수 있다.
  


## 3.13. <표3.2>의 참게 예제 자료에서 무게(weight, 단위:kg)를 예측변수(x=무게)로 간주하고, 부수체의 수(sat)를 반응변수(Y=부수체의 수)로 하는 포아송 로그선형모형을 적합하여라.

### a. 예측식을 구하고 암참게의 평균 무게가 2.44kg일 때 부수체의 평균수를 추정하라.
  
```{r 13-a}
dt <- read.table('Crabs.txt', header = TRUE)
fit <- glm(sat ~ weight, family = poisson, data = dt)
summary(fit)
```
  
  주어진 데이터에 포아송 로그선형모형을 적합한 결과는 위와 같고, 이를 바탕으로 예측식을 구하면 다음과 같다.
  
$$
log(\mu) = \alpha + \beta x = -0.4284 + 0.5893x
$$
  
  회귀분석 결과 $\hat \beta=0.5893$으로 추정되었고, 해당 추정치에 대한 왈드 통계량은 $z^2 = 9.064^2 = 82.16$으로 df=1인 $\chi^2$분포 하에서 이보다 극단적인 값을 가질 확률은 <0.01이다. 따라서 유의수준 0.05 수준에서 귀무가설 $H_0 : \beta = 0$을 기각하며, 투구게의 중량은 부수체의 수에 영향을 미친다고 결론내릴 수 있다.
  위 모형에 따라 투구게 암컷의 평균 중량이 2.44kg인 경우, 해당 개체의 부수체 평균수는 $e^{-0.4284 + 0.5893*2.44} = 2.74$로 예측할 수 있다.
  
  
  
b. $\hat{\beta}$을 이용하여 무게의 효과를 설명하라. 모수 $\beta$와 무게가 1kg 증가할 때마다 발생하는 승법효과에 대한 95% 신뢰구간을 구하라.
  
  $\hat \beta=0.5893$이므로 중량에 따라 부수체의 수가 증가할 것이라고 예측할 수 있고, 중량이 1kg 증가할 때마다 부수체의 수는 $e^0.5893 = 1.8$개 증가할 것으로 예측할 수 있다.

```{r 13-b}
confint(fit)
```
  
  $\hat \beta$의 95% 프로파일 신뢰구간을 구한 결과는 위와 같다. $\hat \beta = (0.4597, 0.7145)$이고, 이를 기준으로 예상한 중량 1kg의 승법효과는 (1.5836, 2.0431) 범위로, 투구게 암컷의 중량이 1kg 증가할 경우 부수체의 숫자가 최소한 58.3% 증가할 것으로 예측할 수 있다.
  $\hat \beta$의 95% 왈드 신뢰구간을 구하면, $ \hat \beta \pm 1.96 \times SE = 0.5893 \pm 1.96 \times 0.065 = (0.4619, 0.7197)$로 예측할 수 있다. 이를 기준으로 예상한 중량 1kg의 승법효과는 (1.587, 2.0538) 범위로, 중량이 1kg 증가하는 경우 부수체의 숫자가 최소한 58.7% 증가할 것으로 예측할 수 있다.
  

### c. 부수체의 평균수와 무게와의 독립성을 왈드와 가능도비 검정을 하고 결과를 해석하라.
  
  부수체 평균 수와 중량 간의 독립성에 관한 검정 가설은 다음과 같다.
  $H_0 : \beta = 0$, $H_a : \beta \neq 0$
  왈드 검정을 위한 검정 통계량은 $z = \frac{\hat \beta}{SE} = \frac{0.5893}{0.065} = 9.066$으로 계산된다. 왈드 검정의 통계량 $z^2 = 82.1924$는 df=1인 $\chi^2$분포를 따르며, 해당 통계량을 기준으로 중심에서 벗어나있는 값의 p값을 기준으로 유의수준과 비교하여 가설을 검정한다. 해당 통계량의 p값은 <0.01로, 0.05 유의수준에서 귀무가설을 기각한다.
  가능도비 검정을 위한 검정 통계량은 $LR = L_0 - L_1 = 632.79 - 560.87 = 71.92$이고, 해당 통계량은 df=1인 $\chi^2$분포를 따른다. 해당 통계량의 p값은 <0.01로, 0.05 유의수준에서 귀무가설을 기각한다.
  따라서, 왈드 검정과 가능도비 검정 결과, 부수체의 평균 수와 투구게 암컷의 중량은 독립 관계가 아니며, 중량이 증가할수록 부수체의 평균 수가 늘어날 것이라고 예측할 수 있다.
  
```{r 13-c}
summary(fit)
```



```{r 13-c-1}
Anova(fit)
```