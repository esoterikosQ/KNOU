---
title: '[DAM]homework3'
author: "Q"
date: "5/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(survival)
library(ggplot2)
library(ISwR)
library(faraway)
```

## 14.1 In the graft.vs.host data set, estimate the survival function for patients with or without GVHD. Test the hypothesis that the survival is the same in both groups. Extend the analysis by including the orther explanatory variables.


```{r 1}
# import data
data(graft.vs.host)
attach(graft.vs.host)
```

### GVHD 유병여부를 기준으로 누적한계추정법을 이용한 생존함수 추정

```{r 1-1}
# create a Surv object 
surv.gvhd <- Surv(time, dead == 1)

# fitting a survival curve using gvhd as an explanatory variable
sc.gvhd <- survfit(surv.gvhd ~ gvhd)
summary(sc.gvhd)
```

생존함수 추정 결과, GVHD 유병 여부에 따라 생존함수가 크게 달라지는 것을 확인할 수 있다. GVHD 유병 그룹은 479일을 기준으로 생존확률이 0.353인 반면, GVHD가 없는 그룹은 465일을 기준으로 생존확률이 0.8이었다. 

```{r 1-2}
# draw a survival curve plot
plot(sc.gvhd, col = c('blue', 'red'), main = 'Surv. curv by GVHD', xlab = 'time(days)', ylab = 'survival rate')
legend('bottomright', legend = c('no', 'yes'), lty = 1, col = 1:2, title = 'GVHD')
```

각각의 생존함수를 그래프로 도출한 결과는 위와 같다. GVHD 유병그룹(빨간색)의 그래프는 무병그룹(파란색)의 생존함수 그래프와 비교해서 현저하게 생존확률이 낮아진 것을 확인할 수 있다.
또한 유병그룹은 생존함수의 마지막 변곡지점도 479일로 무병그룹에 비해 장기 생존 데이터가 부족한 것을 알 수 있다.

### 로그-순위 검정법을 이용하여 GVHD 변수의 설명력 검증

```{r 1-3}
survdiff(surv.gvhd ~ gvhd)
```

모수 $\rho=0$를 가정한 로그-순위 검정을 통해 GVHD 유병 여부를 통해 생존함수 일치성 여부를 검정한 결과는 위와 같다.

두 그룹의 동질성을 가정하는 귀무가설을 검정한 결과 $\chi^2=6.6$으로, p값은 0.01로 95% 유의수준에서 귀무가설을 기각할 수 있는 것으로 확인되었다. 따라서 GVHD는 생존함수에 유의미한 영향을 주는 것을 알 수 있다.


### 콕스 비례위험모형을 이용한 모형 확장

```{r 1-4}
# fitting a regression model
sc.all <- coxph(surv.gvhd ~ gvhd + rcpage + donage + factor(type) + factor(preg))
summary(sc.all)
```

콕스 비례위험모형을 이용하여 생존함수를 분석한 결과는 위와 같다.

검정의 대상이 된 회귀모형은 다음과 같다.
$$
S(t) = [S_0(t)]^{-exp(2.095x_1-0.016x_2+0.044x_3-0.337x_{4-1}-2.421x_{4-2}+0.343x_5)}
$$
우도비 검정, Wald 검정, Score 검정 결과, 모두 p값이 0.002 이하의 작은 값으로 나와, GVHD 유병여부(gvhd, $x_1$), 수여자 나이(rcpage, $x_2$), 공여자 나이(donage, $x_3$), 백혈병 종류(type, $x_4$), 공여자 임신여부(preg, $x_5$) 중 최소 한 가지 이상은 생존함수에 영향을 미치는 것을 알 수 있다.

각 변인별로는 GVHD 유병여부, 만성 골수성 백혈병(type=3)이 생존함수에 영향을 미치는 것으로 나타났고, 나머지 변인들은 p값이 유의미하지 않은 것으로 나타났다. 구체적으로 GVHD 유병그룹은 무병그룹보다 8.125배 위험도가 높고, 만성 골수성 백혈병이 발병한 경우 급성 골수성 백혈병이 발병한 경우에 비해 위험도가 0.08배 높은 것으로 나타났다.


## 14.3 Fit Cox models to the stroke data with age and sex as predictors and with sex alone. Explain the difference. 


### 콕스 비례위험모형을 이용한 stroke 데이터 분석

```{r 2}
# import data
detach(graft.vs.host)
data(stroke)
attach(stroke)
```


```{r 2-1}
# creating a survival data
surv.str <- Surv(obsmonths, dead)
# fitting a cox model with age and sex as predictors
sc.both <- coxph(surv.str ~ sex + age)
# fitting a cox model with sex alone as a predictor
sc.sex <- coxph(surv.str ~ sex)

summary(sc.both)
summary(sc.sex)
```

설명변수를 달리하여 Cox 위험비례모형을 이용하여 생존함ㅁ수를 분석한 결과, 셩별만 고려한 모형의 경우 성별에 대한 유의수준이 매우 낮게 나왔으나, 성별과 연령을 모두 고려한 모형의 경우 오히려 성별에 대한 유의수준이 높아져 유의미하지 않게 나타나고 연령의 유의수준이 낮은 것으로 나타났다. 또한 성별만 고려한 모형에 비해 성별과 연령을 모두 고려한 모형의 c-index가 0.66으로 성별만 고려한 모형의 0.547보다 높게 나타나 모형 설명력이 높은 것으로 나타났다.

이러한 검정 결과를 설명해줄 수 있는 가설은, 남성의 뇌졸중 발병 나이가 여성보다 어리다는 설명이다. 즉, 셩별과 뇌졸중 발병 나이 간 밀접한 관련이 있는 경우, 나이를 포함하지 않은 모형에서 성별이 유의미한 변수로 나타날 수 있다. 이러한 가설을 검정하기 위해 성별과 나이간의 상관관게를 검정한 결과는 다음과 같다. 

```{r 2-2}
cor.test(as.numeric(sex), age)
```

두 변수의 상관관계 검정 결과 상관계수는 0이 아닌 것으로 나타났고, 음의 상관관계가 있는 것으로 나타나 남성(sex==2)의 뇌졸중 발병 나이는 여성(sex==1)의 발병 나이보다 낮다는 것을 확인할 수 있다.


##1-1. For the prostate data, fit a model with lpsa as the response and the other variables as predictors.

```{r 1}
# import data
detach(stroke)
data(prostate)
summary(prostate)
```

###(a) Compute 90 and 95% CIs for the parameter associated with age. Using just these intervals, what could we have deduced about the p-value for age in the regression summary?

###(b) Compute and display a 95% joint confidence region for the parameters associated with age and Ibph. Plot the origin on this disply. The clocation of the origin on the display tells us the outcome of a certain hypothesis test. State that test and its outcome.

###(c) Suppose a new patient with the following values arrives. Predict the lpsa for this patient along with an appropriate 95% CI.



##1-3. using the teengamb data, fit a model with gamble as the response and the other variables as predictors.

###(a) Which variables are statistically significant?

###(b) What interprtation should be given to the coefficient for sex?

###(c) Predict the amount that a male with average (given these data) status, income and verbal score would gamble along with an appropriate 95% CI. Repeat the prediction for a mail with maximal values(for this data) of status, income and verbal score. Which CI is wider and why is this result expected?

###(d) Fit a model with just income as a predictor and use an F-test to compare it to the full model.
