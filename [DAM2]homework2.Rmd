---
title: "dam2"
author: "SeungGyu Bak"
date: "2022-09-11"
output: word_document
---

```{r setup, include=FALSE}
library(vcd)
library(vcdExtra)
```

##다음 표는 2016년도 일반사회조사로부터 얻은 것이다. 

| 인종 | 정당지지도               |
|------|--------|--------|--------|
|      | 민주당 | 공화당 | 무소속 |
| 백인 | 871    | 821    | 336    |
| 흑인 | 347    | 42     | 83     |

###a. 정당지지 성향과 인종 간의 독립성 검정을 하고 결과를 해석하라.

```{r 1-a}
# create a dataset
party <- matrix(c(871, 821, 336, 347, 42, 83), ncol = 3, byrow = TRUE, 
                dimnames = list('race' = c('white','black'), 'party' = c('dem','rep','ind')))

# indenpendence test
chisq.test(party)
```
  
인종과 정당 정체성 간의 독립성 검정을 위한 귀무가설은 $H_0$ : 인종과 정당 정체성은 서로 독립이다. 이를 검정하기 위해 피어슨의  $\chi^2$ 통계량을 산출한 결과, $\chi^2$ 통계량은 184.32, 자유도는 (X-1)$\times$(Y-1) = 2가 된다. 이 통계량의 p-value는 <0.0001로, 0.05 유의수준에서 귀무가설을 기각할 수 있다.  

따라서, 인종은 정당 정체성 간에는 연관성이 있는 것으로 해석할 수 있다.


###b. 표준화 잔차를 사용하여 연관성의 증거를 기술해 보아라.

```{r 1-b}
# standardized residuals
stdres <- chisq.test(party)$stdres
stdres
```
  
주어진 분할표의 표준화 잔차를 계산한 결과는 위 표와 같다. 귀무가설이 참이라고 가정했을 때의 기대도수에 비해 흑인의 경우 민주당에, 백인의 경우 공화당에 대한 정체성을 가지고 있는 경우가 많았다. 따라서, 흑인은 민주당의 정체성에, 백인은 공화당의 정체성에 가까운 성향으로 인종과 정당 정체성 간의 연관성이 있다는 것을 알 수 있다.  
  
구체적인 수치상 근거를 위해 자신의 정당 정체성을 민주당 또는 공화당으로 응답한 표본만을 기준으로 오즈비를 계산하면, 

$$
OR = \frac{n_{11}\times n_{22}}{n_{12}\times n_{21}} = \frac{871 \times 42}{347 \times 821} = 0.128
$$
  
이므로, 민주당의 정체성을 가지고 있을 오즈는 백인의 경우 흑인보다 87.2% 낮다고 할 수 있다.

```{r}
# mosaic plot of std. res.
mosaic(party, gp = shading_Friendly, residuals = stdres, residuals_type = 'Std\nresiduals', labeling = labeling_residuals)
```
  
분할표의 각 도수 차이와 잔차 간의 상대적인 크기 비교를 위해 모자이크 플롯을 그린 결과는 다음과 같다. 전체 도수는 백인이 흑인보다 크지만, 흑인의 경우 민주당의 정체성을 가지고 있는 응답자의 비율이 확연히 큰 것을 알 수 있다. 반면 백인의 경우 전체 도수상으로는 민주당과 공화당 간의 차이가 크지 않다. 따라서 귀무가설 하에서 백인의 경우 공화당, 흑인의 경우 민주당에 해당하는 표준화 잔차가 크게 나타나고, 피어슨의 $\chi^2$ 통계량은 귀무가설을 기각하는 것으로 나타나는 것을 알 수 있다.

###c. 카이제곱을 두 개의 부분항으로 분할한 후에 부분항을 사용하여 인종과 정당지지(민주당, 공화당)의 연관성의 증거를 기술하고 차이를 해석하라.

서로 독립적인 $\chi_2$ 통계량은 다음 관계를 만족한다.
$$
\chi^2_a \ + \ \chi^2_b \ = \ \chi^2_{a+b}
$$
이 관계를 이용하여 자유도가 2인 $G^2$를 자유도가 1인 두 개의 $G^2$ 통계량으로 분할할 수 있다.

$$
G^2 = 2\sum n_{ij} log \frac{n_{ij}}{\mu_{ij}}
$$
  
위 식에 따라 $G^2$값을 계산하면,

```{r}
g.sqr <- function(data) {
  r <- nrow(data) # 행의 개수
  c <- ncol(data) # 열의 개수
  total.sum <- sum(data) # 전체 분할표 도수의 총합
  # 기대도수표 생성
  exp.table <- matrix(c(0), nrow = r, ncol = c) # 비어있는 매트릭스 생성
  for(i in 1:r){ # 각 행에 대해
    row.sum <- sum(data[i,]) # 행의 합계 = n_i+
    for(j in 1:c){ # 각 열에 대해
      col.sum <- sum(data[,j]) # 열의 합계 = n_+j
      exp.table[i, j] <- (row.sum*col.sum)/total.sum # 기대도수 = (n_i+ * n_+j) / N
    }
  }
  # calculating g^2 table
  g2.table <- data*log(data/exp.table) # 각 구획의 로그우도비 = n_ij * log(n_ij / mu_ij)
  # calculating g^2
  result <- 2*sum(g2.table, na.rm = TRUE) # 모든 구획의 로그우도비를 합한 값에 2를 곱한 값
  print(result)
}

g.sqr(party)
```

213.9이 되고, 이 때의 자유도는 (X-1)$\times$(Y-1) = 2가 된다.  

다음으로, $G^2$값을 분할하기 위해 우선 앞의 두 변수 (민주당, 공화당)만을 추출해서 $G^2$ 값을 계산하면,

```{r}
g.sqr(party[,-3])
```

213.62가 되고, 이 때의 자유도는 1이 된다.

다음으로, (민주당+공화당, 무소속)의 순서로 재편집한 데이터를 바탕으로 $G^2$값을 계산하면,
```{r}
party.2 <- cbind(apply(party[,-3], 1, sum), party[,3])
g.sqr(party.2)
```

0.28이 되고, 이 때의 자유도는 1이 된다.
  
따라서, 원데이터의 $G^2$값은 다음과 같이 분해할 수 있다.
$$
213.9011 = 213.6202 + 0.2809
$$
  
따라서, 인종에 따른 정당 정체성의 구별에는 민주당과 공화당에 대한 정체성만 유의미하고, 무소속에 대한 정체성에는 영향을 미치지 못하는 것을 확인할 수 있다.


##1991년 일반사회조사에서 조사된 다음의 4$\times$4 분할표는 흑인들에 대해서 직업 만족도와 수입에 대해서 조사한 결과를 보여준다.

| 수입          | 직업만족도                                        |
|---------------|-------------|-----------|-------------|-----------|
|               | 매우 불만족 | 약간 만족 | 적절히 만족 | 매우 만족 |
| <5,000        | 2           | 4         | 13          | 3         |
| 5,000~15,000  | 2           | 6         | 22          | 4         |
| 15,000~25,000 | 0           | 1         | 15          | 8         |
| >25,000       | 0           | 3         | 13          | 8         |

```{r}
# create a dataset
sat <- matrix(c(2, 2, 0, 0, 4, 6, 1, 3, 13, 22, 15, 13, 3, 4, 8, 8), ncol=4, 
              dimnames = list(income = c('<5,000','5,000~15,000','15,000~25,000','>25,000'),
                              satisfaction = c('very unsatisfied','unsatisfied','satisfied','very satisfied')))
```

###a. $\chi^2$ 검정을 이용하여 직업만족도와 수입 간의 독립성 검정을 수행하라.  
###검정결과를 해석하고 이 자료에 대해서 이 검정이 갖고 있는 문제점을 설명하라. 표준화잔차를 구하라. 어떠한 패턴을 보이고 있는가?


```{r 2-a}
# chi-square test
chisq.test(sat)
```
  
피어슨 $\chi^2$ 검정 결과, $\chi^2=11.524$, df=9로, p값은 0.2415로 계산되어 독립성에 대한 귀무가설 <$H_0$ : 수입 수준과 직업 만족도는 독립적이다> 를 기각할 수 없다.  

하지만 자료의 특성상 이러한 해석에는 오류가 있는데, 우선 분할표의 일정 구획에서는 도수가 0이고, 통계량의 $\chi^2$ 분포 가정을 뒷받침하기 위한 적절한 수의 빈도($n_{ij}>5$)에 미치지 못하는 구획도 여러 개 보인다. 실제로 $G^2$ 값을 구하는 과정에서 실제 도수 $n_{ij}=0$인 경우, 조건부 로그우도비 값 $log(\frac{n_{ij}}{\mu_{ij}})=-\infty$이 되어 일부 구획에서 값이 계산되지 않는다. 이러한 구획을 모두 0으로 간주하고 $G^2$ 값을 계산하면, 

```{r}
g.sqr(sat)
1- pchisq(13.2673, df=9)
```

$G^2=13.2673$이고, df = 9 이다. 이는 귀무가설을 기각할 수 없다는 결론에서는 $\chi^2$ 통계량과 차이는 없지만, 상당한 p값 차이를 가지고 있다.

```{r} 
# standardized residuals
stdres <- chisq.test(sat)$stdres
stdres
```

변수 간 독립을 가정한 귀무가설을 바탕으로 예측한 기대도수와 실제 관측된 도수 간의 차이를 표준화한 표준화 잔차를 살펴보면, 변수 간 관계에 일정한 경향성이 있다는 점을 확인할 수 있다. 잔차값이 0보다 큰 구획은 소득 수준이 높아짐에 따라 매우 불만족에서 매우 만족으로 점차 이동하는 것을 확인할 수 있다. 이에 따르면 독립성 가설을 기각하지 못한 통계량과 달리 소득과 직업 만족도 간에 연관성이 있다는 추정이 가능하다. 
  
이상과 같은 통계량 값 간의 차이, 독립성 가설에 대한 통계량과 표준화 잔차 간의 해석 차이는 척도형 변수인 소득 수준과 만족도를 명목형 변수로만 해석하는 $\chi^2$ 통계량의 한계에서 비롯한다. 즉, (소득수준 1 - 2 - 3 - 4)가 의미하는 순서의 정보를 무시하고 변수의 각 급간을 단순히 '다른 소득'으로만 취급하기 때문에 수준 차이에서 생기는 잔차의 변동이 유의미한 것인지 아닌지를 통계량에 반영할 수 없는 것이다. 이처럼 서수적인 변수를 포함하는 자료의 경우 $M^2$ 통계량을 사용하는 것이 바람직하다.
  
또한, 전체 구획 수($r \times c = 16$)에 비해서도, 절대적으로도 각 구획의 도수가 충분히 크지 않기 때문에 통계량이 가정하는 '카이제곱 분포'에 근사되지 않는 문제가 있다. 구획 별 관측된 도수가 작은 경우에는 $G^2$값이 유용하지만, 전체 구획 수에 비해 관측도수 크기가 작을 때에는 카이제곱 분포로 근사되는 속도가 빠른 $\chi^2$가 유리하다. 소표본 관측치인 경우에는 피셔의 정확도 검정(exact test)을 이용해야 정확한 통게적 추론이 가능하다.


###b. 수입에 대해서는 (3, 10, 20, 35) 점수를 사용하고 직업만족도에 대해서는 (1, 3, 4, 5) 점수를 사용하여 변수들을 질적인 형태로 간주한 후에 검정을 수행하라. 왜 이 검정결과가 (a)와 다른지 설명하라.

```{r 2-b}
# transform the category of the original dataset
sat2 <- sat
dimnames(sat2) = list(c(3, 10, 20, 35), c(1, 3, 4, 5))

# CMH test
CMHtest(sat2, rscores = c(3, 10, 20, 35), cscores = c(1, 3, 4, 5))
```

수입과 직업 만족도를 양적 변수로 변환하여 독립성 검정을 한 결과는 다음과 같다. $M^2$ 통계량은 7.04, df = 1로 p값은 < 0.01 수준으로 계산되어, 0.05 유 의수준에서 독립성을 가정한 귀무가설을 기각할 수 있다.
  
이와 같이 단순 $\chi^2$ 검정과 다른 결과가 나타나는 이유는, $M^2$ 통계량은 변수 간의 피어슨 상관계수를 포함하고 있어서 변수의 서수적인 특성이 통계량에 반영되기 때문이다. 즉, X변수와 Y변수의 선형 추세를 -1부터 1사이의 값으로 표현하기 때문에 이 값이 반영된 통계량은 단순히 급간의 차이만을 비교하는 $\chi^2$ 통계량에 비해 변수의 서수적인 특성이 통계량에 나타난다.

$$
M^2 = (n-1)R^2
$$
$$
R^2 = \frac{\sum_{i,j}(u_i - \bar{u})(v_j - \bar{v})\hat{\pi}_{ij}}{\sqrt{[\sum_i{(u_i - \bar{u})}^2 \hat{\pi}_{i+}][\sum_i{(v_i - \bar{v}}^2 \hat{\pi}_{+j})}]}
$$
  
$M^2$는 df = 1로, n이 커짐에 따라 카이제곱 분포에 근사한다. 또한, 자유도가 1이기 때문에 df = (r-1)(c-1)을 가지는 $\chi^2$이나 $G^2$ 통계량보다 분산이 작아 n이 커짐에 따라 평균으로 수렴하는 속도가 빠르고, 같은 통계량이 갖는 p값이 더 낮아 가설 검정에 유리한 특성을 갖는다.
  
이처럼, 서수적 변수가 하나라도 포함된 범주형 데이터 분석을 할 때에는 $M^2$ 통계량을 사용하는 것이 유리하다.